// This file is for your Firebase Cloud Function.
// You will REPLACE the entire content of your existing 'index.js' with this new code.

const functions = require("firebase-functions");
const admin = require("firebase-admin");
const axios = require("axios");
const cors = require("cors")({ origin: true });
const logger = require("firebase-functions/logger");

// Initialize the Firebase Admin SDK
admin.initializeApp();

// This is our "Town Crier" function. It runs automatically every 1 minute.
exports.updatePiPrice = functions.pubsub.schedule('every 1 minutes').onRun(async (context) => {
    logger.info("Scheduled function triggered: Fetching Pi price from CoinGecko.");
    try {
        const url = "https://api.coingecko.com/api/v3/simple/price?ids=pi-network-iou&vs_currencies=php";
        const result = await axios.get(url);
        const piData = result.data;

        if (piData && piData['pi-network-iou'] && piData['pi-network-iou'].php) {
            const price = piData['pi-network-iou'].php;
            const db = admin.firestore();
            await db.collection('marketData').doc('piPrice').set({
                price: price,
                updatedAt: admin.firestore.FieldValue.serverTimestamp()
            });
            logger.info(`Successfully updated Pi price in Firestore to: ${price}`);
        } else {
             logger.warn("CoinGecko API did not return valid data.");
        }
    } catch (error) {
        logger.error("Error fetching price from CoinGecko and updating Firestore:", error);
    }
    return null;
});

// NEW: This is our "Front Desk" function that creates a Firebase "Visitor Pass".
exports.createFirebaseToken = functions.https.onRequest((request, response) => {
    cors(request, response, async () => {
        try {
            const piUid = request.body.piUid;
            if (!piUid) {
                logger.warn("Pi UID not provided in request.");
                return response.status(400).send({ error: "Pi UID is required." });
            }
            
            logger.info(`Generating custom token for Pi user: ${piUid}`);
            const firebaseToken = await admin.auth().createCustomToken(piUid);
            
            response.status(200).send({ token: firebaseToken });

        } catch (error) {
            logger.error("Error creating custom token:", error);
            response.status(500).send({ error: "Failed to create custom token." });
        }
    });
});
