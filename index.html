<!--
    Timestamp: Thursday, September 11, 2025 at 6:36 AM PST
    File Name: index.html
    Full File Path: index.html

    App Functionality:
    This application provides a user interface for Pi Network users in the Philippines to exchange their Pi coins for Philippine Pesos (PHP) via GCash. It features user authentication, real-time price tracking from a secure backend, and a form to submit transaction details to an administrator for manual verification and payment.

    Modifications Made in This Version:
    - Added: A new inactivityTimer and a constant INACTIVITY_TIMEOUT_MS (set to 3 minutes or 180,000ms).
	- Added: The resetInactivityTimer and handleUserActivity functions, which work together to detect user activity and trigger the timeout.
	- Added: Event listeners for mousemove, mousedown, keydown, and touchstart to call handleUserActivity and reset the timer.
	- Revised: The initApp function. It now always calls showView('fbGate') first. The onAuthStateChanged block now correctly handles the login state but always returns to the Facebook gate view.
	- Revised: The fbContinueBtn event listener now checks if the user is authenticated (if (user)) before redirecting to the main app, ensuring a proper login flow.
	- Revised: The Pi wallet address is no longer hardcoded. A new fetchPiWalletAddress function now uses getDoc to read the address from the marketData/piWallet document in Firestore. The value is then used to update the <input> element.
	- Revised: The copyAddressBtn event listener now correctly copies the value from the dynamic input field.
	- Revised: The fetchPrice function was renamed to fetchPriceAndWallet to also include fetching the wallet address on demand.
	- Deleted: The localStorage check for fb_gate_passed has been completely removed to ensure the Facebook gate is a constant first page.
	- FIXED: The user authentication flow has been corrected so that the login view is shown first if the user is not authenticated. The Facebook invitation page is now only shown after a successful login.
    - FIXED: Removed the redundant and incorrect `DOMContentLoaded` listener at the end of the script. The authentication check is now centralized within the `initApp` function to prevent the "race condition" that caused the views to overlap.
    - Added: A new section to the header that displays the admin's online/offline status using a colored dot and text. This status is fetched from Firestore.
    - Added: A new Firestore listener to the `marketData/adminStatus` document to update the status indicator in real-time.
    - Added: A new section with a clear informational message for the user about the admin's online status and what to do if they are offline.
    - Added: A new pop-up modal to warn the user about submitting an order while the admin is offline.
    - Revised: The `handleSubmitTransaction` function now checks the admin's status and shows the new warning modal if they are offline, before proceeding with the transaction submission.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi to GCash Exchange</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><path fill='%23FBBF24' d='M2,16 L8,10 V14 C16,14 22,18 22,26 C20,21 15,19 8,19 V23 L2,16 Z'></path><path fill='%233B82F6' d='M30,16 L24,22 V18 C16,18 10,14 10,6 C12,11 17,13 24,13 V9 L30,16 Z'></path></svg>">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .backdrop-blur-sm { backdrop-filter: blur(4px); }
        
        /* --- Toast Notification Styles --- */
        #toast-container {
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        .toast {
            padding: 1rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            animation: slideIn 0.3s ease-out forwards, slideOut 0.3s ease-in 3.2s forwards;
            max-width: 320px;
        }
        .toast.success { background-color: #16a34a; } /* bg-green-600 */
        .toast.error { background-color: #dc2626; } /* bg-red-600 */

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
    </style>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1048178550469494"
     crossorigin="anonymous"></script>
</head>
<body class="bg-gray-900 text-gray-200">

    <div id="toast-container"></div>

    <div id="loading-view" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900">
        <svg class="animate-spin h-8 w-8 text-blue-500 mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-lg text-gray-400">Initializing Secure Connection...</p>
    </div>

    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[100] hidden backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-lg w-11/12 md:w-full max-w-md shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-center mb-4 text-white">Confirm Your Transaction Details</h3>
            <div id="confirm-details" class="bg-gray-700 p-4 rounded-md space-y-2 text-sm">
                </div>
            <div class="mt-6 flex justify-between gap-4">
                <button id="cancel-confirm-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-md transition">Cancel</button>
                <button id="confirm-submit-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md transition">Confirm & Submit</button>
            </div>
        </div>
    </div>

    <!-- New Offline Warning Modal -->
    <div id="offline-warning-modal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-[100] hidden backdrop-blur-sm">
        <div class="bg-gray-800 p-6 rounded-lg w-11/12 md:w-full max-w-md shadow-2xl border border-gray-700">
            <h3 class="text-xl font-bold text-center mb-4 text-orange-400">Admin is Currently Offline</h3>
            <p class="text-gray-300 text-sm text-center mb-4">
                The GCash Buyer is not currently online to process real-time payments.
                You may still submit your order, and it will be processed when the admin
                comes back online.
            </p>
            <p class="text-sm font-semibold text-center text-red-400 mb-6">
                 If you proceed, remember to capture a screenshot of your Pi transfer
                 for verification.
            </p>
            <div class="mt-6 flex justify-between gap-4">
                <button id="cancel-offline-btn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 rounded-md transition">Cancel</button>
                <button id="proceed-offline-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-md transition">Proceed Anyway</button>
            </div>
        </div>
    </div>


    <div id="app-container" class="max-w-2xl mx-auto p-4 md-p-6">

        <header id="app-header" class="sticky top-0 z-40 bg-gray-900/80 backdrop-blur-sm py-4 mb-6 text-center hidden shadow-md">
            <div class="flex items-center justify-center">
                <img src="pi2gc-logo.png" alt="Pi2GCash Logo" class="h-16 w-auto">
            </div>
            <div id="user-info" class="text-xs text-gray-400 mt-2"></div>
            <div id="admin-status" class="mt-4 flex items-center justify-center space-x-2 p-2 bg-gray-800 rounded-full w-fit mx-auto">
                <span id="status-dot" class="w-2.5 h-2.5 rounded-full animate-pulse bg-gray-500"></span>
                <span id="status-text" class="text-xs font-bold text-gray-400">Admin Status: Loading...</span>
            </div>
        </header>

        <div id="login-view" class="hidden text-center py-20">
            <div class="flex items-center justify-center space-x-3 mb-4">
                 <img src="pi2gc-logo.png" alt="Pi2GCash Logo" class="h-20 w-auto">
            </div>
            <p class="mb-6 text-gray-400">Securely sign in to start your transaction.</p>
            <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg inline-flex items-center">
                <svg class="w-4 h-4 mr-2" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 110.3 512 0 398.8 0 256S110.3 0 244 0c73 0 134.3 29.2 179.8 73.4L372.3 128.9C339.7 99.8 296.2 80 244 80c-87.6 0-159.3 70.2-159.3 176s71.7 176 159.3 176c98.2 0 135-70.4 140.8-106.9H244v-85.3h236.1c2.3 12.7 3.9 26.9 3.9 41.8z"></path></svg>
                Sign in with Google
            </button>
        </div>

        <div id="fb-gate-view" class="hidden bg-gray-800 p-8 rounded-lg text-left">
             <h2 class="text-2xl font-bold mb-4 text-center text-cyan-400">Welcome! One Final Step to Secure Your Transactions</h2>
             <p class="text-gray-300 mb-6 text-center">To ensure a **secure and transparent** community, we highly recommend all users join our official Facebook group. This is our commitment to you that **we are legitimate buyers** and your transactions are safe with us.</p>
            
             <div class="space-y-4 text-gray-300 bg-gray-900/50 p-4 rounded-lg border border-gray-700">
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008H12v-.008z" /></svg>
                    <div>
                        <h3 class="font-bold">Transaction Security & Support</h3>
                        <p class="text-sm text-gray-400">If any issues arise, the group is our primary channel for resolving problems. You can post screenshots and communicate directly with admins to ensure a swift resolution. In the rare case of a system fault, being a member is the most secure way for us to return your Pi to the correct wallet.</p>
                    </div>
                </div>
                 <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h1.5m-1.5 3h1.5m-7.5 3h7.5m-7.5 3h7.5m3-9h3.375c.621 0 1.125.504 1.125 1.125V18a2.25 2.25 0 01-2.25 2.25M16.5 7.5V18a2.25 2.25 0 002.25 2.25M16.5 7.5V4.875c0-.621-.504-1.125-1.125-1.125H4.125C3.504 3.75 3 4.254 3 4.875V18a2.25 2.25 0 002.25 2.25h13.5M6 7.5h3v3H6v-3z" /></svg>
                    <div>
                        <h3 class="font-bold">Stay Updated and Informed</h3>
                        <p class="text-sm text-gray-400">Get the latest news on Pi Network developments, market rates, and future progress. We also post updates on pending and completed transaction batches in the group for full transparency.</p>
                    </div>
                </div>
                <div class="flex items-start space-x-3">
                    <svg class="w-5 h-5 text-green-400 flex-shrink-0 mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M18 18.72a9.094 9.094 0 003.741-.479 3 3 0 00-4.682-2.72m-7.5-2.962A3.375 3.375 0 019 12.125v1.5a3.375 3.375 0 01-3.375 3.375H3.375A3.375 3.375 0 010 13.625v-1.5A3.375 3.375 0 013.375 8.625h1.5A3.375 3.375 0 019 12.125v1.5a3.375 3.375 0 01-3.375 3.375M9 12.125v1.5a3.375 3.375 0 003.375 3.375h1.5A3.375 3.375 0 0018 13.625v-1.5A3.375 3.375 0 0014.625 8.625h-1.5A3.375 3.375 0 009 12.125z" /></svg>
                    <div>
                        <h3 class="font-bold">A Hub for the Pi Community</h3>
                        <p class="text-sm text-gray-400">Our group is a place to communicate and exchange information with fellow enthusiasts about Pi and the wider crypto world.</p>
                    </div>
                </div>
             </div>

             <a href="https://www.facebook.com/groups/751884982155761" target="_blank" class="block w-full bg-blue-800 hover:bg-blue-900 text-white font-bold py-3 px-4 rounded-lg my-6 text-center">Join the PiCoinPH Facebook Group</a>
             <button id="fb-continue-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">I Have Joined, Continue to App</button>
        </div>
        
        <main id="main-view" class="hidden space-y-6">
            <div class="bg-gray-800 p-6 rounded-lg border border-yellow-500">
                <h3 class="text-xl font-bold mb-3 text-center text-yellow-400">Important: Real-Time Payment Notice</h3>
                <p class="text-sm text-gray-300">
                    For immediate processing of your order, please verify that the **Admin / GCash Buyer is currently online** based on the status above.
                </p>
                <p class="text-sm text-gray-300 mt-2">
                    If the status is currently **Offline**, you may still proceed with your Pi transfer, but please be aware that your order will be processed and the GCash payment will be completed when the Admin becomes available. We highly recommend capturing a screenshot of your Pi wallet transfer as proof.
                </p>
            </div>
            
            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-cyan-400">Step 1: Transfer Your Pi</h3>
                 <div class="space-y-4">
                    <p class="text-sm text-gray-400">Use the buttons below to open your Pi Browser and access your Pi Wallet.</p>
                    
                    <div id="app-launchers" class="bg-gray-700 p-4 rounded-lg">
                        <p class="text-center font-semibold mb-3">Quick App Launchers</p>
                        <div class="grid grid-cols-3 gap-2">
                            <a href="intent://#Intent;package=com.blockchainvault;end" class="bg-orange-600 text-white p-3 rounded-lg text-center hover:bg-orange-700 transition">Pi Network</a>
                            <a href="intent://#Intent;package=pi.browser;end" class="bg-amber-500 text-black p-3 rounded-lg text-center hover:bg-amber-600 transition">Pi Browser</a>
                            <a href="intent://#Intent;package=com.globe.gcash.android;end" class="bg-blue-600 text-white p-3 rounded-lg text-center hover:bg-blue-600 transition">GCash</a>
                        </div>
                    </div>
                    
                    <div id="webview-warning" class="hidden bg-red-900/50 border border-red-700 text-center p-4 rounded-lg">
                        <p class="font-bold text-red-300 mb-2">App Launchers Disabled</p>
                        <p class="text-sm text-red-200 mb-4">It looks like you're in a social media browser. For full functionality, please open this page in your phone's main browser (like Chrome or Safari).</p>
                        <button id="copy-link-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md">Copy Page Link</button>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-400 mt-4">Transfer the amount of Pi you want to exchange to this exact wallet address:</p>
                        <div class="mt-2 flex items-center bg-gray-700 p-2 rounded-md">
                            <input id="pi-wallet-address" readonly class="bg-transparent font-mono text-base sm:text-lg w-full text-amber-400" value="GB4GBQKCHJ7XBF6EQYMQHHYHXU7XPVTXUU2NJR37YUL6EFJ4243OFHDB">
                            <button id="copy-address-btn" class="ml-2 bg-gray-600 hover:bg-gray-500 text-white font-bold p-2 rounded-md">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                            </button>
                        </div>
                        <p class="text-xs mt-2 text-yellow-300">Warning: Double-check the address. Use the copy button to avoid mistakes. Crypto transfers are irreversible.</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-purple-600 to-indigo-700 p-6 rounded-lg text-center shadow-lg">
                <h2 class="text-lg font-medium text-white flex justify-center items-baseline gap-x-1.5">
                    <span>Direct to</span>
                    <span class="font-bold text-blue-500 text-2xl" style="text-shadow: 1px 1px 3px rgba(0,0,0,0.6);">GCASH</span>
                    <span>rates</span>
                </h2>
                <p id="gcash-rate" class="text-6xl md:text-7xl font-black text-lime-400 my-2" style="text-shadow: 2px 2px 8px rgba(0,0,0,0.9);">Loading...</p>
                <p class="text-xs text-indigo-300">Rate updates when you type or click the button below.</p>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-cyan-400">Step 2: Submit Your Transaction</h3>
                <p class="text-sm text-gray-400 mb-4">After you have sent the Pi, fill out this form to notify the admin. Payment will be sent to the GCash number you provide.</p>
                <form id="transaction-form" class="space-y-4">
                    <div>
                        <label for="pi-wallet-source" class="block text-sm font-medium text-gray-300">Your Pi Wallet Source Address</label>
                        <input type="text" id="pi-wallet-source" name="pi-wallet-source" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-3">
                    </div>
                    <div>
                        <label for="pi-sent" class="block text-sm font-medium text-gray-300">Amount of Pi You Sent (π)</label>
                        <input type="number" id="pi-sent" name="pi-sent" step="any" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-3">
                    </div>
                    <div>
                        <label for="gcash-name" class="block text-sm font-medium text-gray-300">Your Full GCash Name</label>
                        <input type="text" id="gcash-name" name="gcash-name" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-3">
                    </div>
                    <div>
                        <label for="gcash-number" class="block text-sm font-medium text-gray-300">Your GCash Number (e.g. 0917...)</label>
                        <input type="text" id="gcash-number" name="gcash-number" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-3">
                    </div>
                    <div>
                        <label for="transaction-datetime" class="block text-sm font-medium text-gray-300">Date & Time of Pi Transfer</label>
                        <input type="datetime-local" id="transaction-datetime" name="transaction-datetime" required class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm text-white focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm p-3">
                    </div>
                    
                     <button type="submit" id="submit-btn" class="mt-6 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center disabled:opacity-50">
                        I Have Sent the Pi, Submit for Verification
                     </button>
                </form>
            </div>

            <div class="bg-gray-900/50 p-6 rounded-lg text-center border border-purple-500">
                <h3 class="text-lg font-medium text-gray-300">Expected GCash Payment</h3>
                <p id="expected-payment-el" class="text-4xl font-bold text-purple-400 my-2">₱0.00</p>
                <p class="text-xs text-gray-400">A ₱20.00 platform fee is deducted to maintain the app and support development.</p>
            </div>

             <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-cyan-400">Step 3: Provide Proof for Faster Verification</h3>
                <p class="text-sm text-gray-400">
                    For faster verification, please provide proof of your transfer. Open your <a href="intent://#Intent;package=pi.browser;end" class="text-amber-400 font-bold hover:underline">Pi Browser</a> app, go to your wallet's transaction history, and take a screenshot of the successful transfer you sent to us. Post this screenshot in our official Facebook Group for the admin's reference: 
                    <a href="https://www.facebook.com/groups/751884982155761" target="_blank" class="text-base font-bold text-orange-400 hover:underline">PiCoinPH</a>.
                </p>
            </div>

             <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-cyan-400">Step 4: Wait for Verification</h3>
                <p class="text-sm text-gray-400">Wait for the admin to verify the transfer and send your payment. You can track the status in "My Transactions" below.</p>
            </div>


             <div class="bg-gray-800 p-6 rounded-lg">
                <h3 class="text-xl font-semibold mb-4 text-white">My Transactions</h3>
                <div id="transactions-list" class="space-y-3">
                    <p class="text-gray-500 text-center">Your submitted transactions will appear here.</p>
                </div>
            </div>
            
            <footer class="text-center py-4">
                <p class="text-sm text-gray-400">
                    <span class="font-bold">Pi Live Market Price:</span> 
                    <span id="pi-price" class="font-semibold text-gray-200">Loading...</span>
                    <span id="price-timestamp" class="text-gray-500 text-xs block"></span>
                </p>
                <button id="update-price-btn" class="mt-2 mb-4 bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-1 px-2 rounded-md transition text-xs">Update Live Price</button>

                 <div class="flex justify-center items-center space-x-4">
                    <a href="https://minepi.com/" target="_blank" class="text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">Pi Network</a>
                    <a href="https://www.coingecko.com/en/coins/pi-network/php" target="_blank" class="text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">CoinGecko</a>
                    <a href="https://www.okx.com/account/login" target="_blank" class="text-sm bg-gray-700 hover:bg-gray-600 text-gray-300 font-semibold py-2 px-4 rounded-lg transition">OKX</a>
                 </div>
            </footer>

        </main>
    </div>

    <script type="module">
        console.log("Script starting...");
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, serverTimestamp, orderBy, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        // =================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyBlq33BQqvRk5HQcHXxJvfBE4iygcoLxfw",
            authDomain: "pi-gcash-p2p-app.firebaseapp.com",
            projectId: "pi-gcash-p2p-app",
            storageBucket: "pi-gcash-p2p-app.appspot.com",
            messagingSenderId: "148063854165",
            appId: "1:148063854165:web:cd335ca3af278034e4fedc",
            measurementId: "G-VVG58MWN3F"
        };
        // =================================================================================

        // --- INITIALIZE FIREBASE ---
        let app, auth, db;
        try {
            console.log("Initializing Firebase App...");
            app = initializeApp(firebaseConfig);
            console.log("Firebase App Initialized.");
            console.log("Initializing Firebase Auth...");
            auth = getAuth(app);
            console.log("Firebase Auth Initialized.");
            console.log("Initializing Firebase Firestore...");
            db = getFirestore(app);
            console.log("Firebase Firestore Initialized.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            document.getElementById('loading-view').textContent = 'Error: Could not connect to services. Please refresh.';
        }

        // --- STATE MANAGEMENT ---
        let user = null;
        let piPrice = 0;
        let currentGcashRate = 0;
        let transactionsUnsubscribe = null;
        let adminStatus = 'unknown'; // New state variable
        let debounceTimer;
        let inactivityTimer;
        const INACTIVITY_TIMEOUT_MS = 180000; // 3 minutes

        // --- UI ELEMENT REFERENCES ---
        const views = {
            loading: document.getElementById('loading-view'),
            login: document.getElementById('login-view'),
            fbGate: document.getElementById('fb-gate-view'),
            main: document.getElementById('main-view'),
        };
        const appHeader = document.getElementById('app-header');
        const userInfoEl = document.getElementById('user-info');
        const loginBtn = document.getElementById('login-btn');
        const fbContinueBtn = document.getElementById('fb-continue-btn');
        const piPriceEl = document.getElementById('pi-price');
        const priceTimestampEl = document.getElementById('price-timestamp');
        const gcashRateEl = document.getElementById('gcash-rate');
        const piWalletAddressInput = document.getElementById('pi-wallet-address');
        const copyAddressBtn = document.getElementById('copy-address-btn');
        const transactionForm = document.getElementById('transaction-form');
        const submitBtn = document.getElementById('submit-btn');
        const piSentInput = document.getElementById('pi-sent');
        const expectedPaymentEl = document.getElementById('expected-payment-el');
        const transactionsList = document.getElementById('transactions-list');
        const updatePriceBtn = document.getElementById('update-price-btn');
        const appLaunchers = document.getElementById('app-launchers');
        const webviewWarning = document.getElementById('webview-warning');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const confirmModal = document.getElementById('confirm-modal');
        const offlineWarningModal = document.getElementById('offline-warning-modal');
        
        // --- TOAST NOTIFICATION FUNCTION ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => {
                toast.remove();
            }, 3500); // Remove toast after 3.5 seconds
        }

        // --- BROWSER DETECTION ---
        function detectInAppBrowser() {
            const ua = navigator.userAgent || navigator.vendor || window.opera;
            // Checks for Facebook, Instagram, etc.
            return (ua.indexOf("FBAN") > -1) || (ua.indexOf("FBAV") > -1) || (ua.indexOf("Instagram") > -1);
        }

        // --- VIEW MANAGEMENT ---
        function showView(viewName) {
            Object.values(views).forEach(view => {
                if (view) view.classList.add('hidden');
            });
            if (views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            if (appHeader) {
                appHeader.classList.toggle('hidden', viewName !== 'main');
            }
        }
        
        function enterMainApp() {
            if (!user) {
                showView('fbGate');
                return;
            }
            userInfoEl.innerHTML = `
                <p>${user.displayName} (${user.email})</p>
                <div class="flex items-center justify-center mt-1">
                    <span class="text-xs text-gray-400 mr-1">User ID:</span>
                    <span class="font-mono text-yellow-400 text-xs">${user.uid}</span>
                    <button id="copy-user-id-btn" class="ml-2 text-gray-400 hover:text-white">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" class="bi bi-clipboard" viewBox="0 0 16 16"><path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1v-1z"/><path d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5-.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5h3z"/></svg>
                    </button>
                </div>
                <div class="mt-2 text-center">
                     <button id="logout-btn" class="text-red-500 hover:text-red-400 font-bold text-sm">Logout</button>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('copy-user-id-btn').addEventListener('click', () => handleCopy(user.uid, 'User ID copied!'));
            showView('main');
            fetchPriceAndWallet();
            listenForTransactions();
            listenForAdminStatus();
            resetInactivityTimer();
        }

        // --- INACTIVITY LOGIC ---
        const resetInactivityTimer = () => {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                console.log("3 minutes of inactivity detected. Redirecting to Facebook gate.");
                if (user) {
                    signOut(auth);
                }
                showView('fbGate');
            }, INACTIVITY_TIMEOUT_MS);
        };
        const handleUserActivity = () => resetInactivityTimer();


        // --- EVENT HANDLERS & LOGIC ---
        async function fetchPriceAndWallet() {
            console.log("Fetching Pi Price and Wallet Address...");
            const priceDocRef = doc(db, "marketData", "piPrice");
            const walletDocRef = doc(db, "marketData", "piWallet");
            
            try {
                // Fetch price
                const priceSnap = await getDoc(priceDocRef);
                if (priceSnap.exists()) {
                    const data = priceSnap.data();
                    piPrice = data.price;
                    currentGcashRate = Math.floor(piPrice * 0.70);
                    const timestamp = data.updatedAt ? data.updatedAt.toDate().toLocaleString() : new Date().toLocaleString();
                    piPriceEl.textContent = `₱${piPrice.toFixed(2)}`;
                    priceTimestampEl.textContent = `as of ${timestamp}`;
                    gcashRateEl.textContent = `₱${currentGcashRate}`;
                    calculateExpectedPayment();
                    console.log(`Price updated from Firestore: ${piPrice}`);
                } else {
                    piPriceEl.textContent = 'Waiting for data...';
                    gcashRateEl.textContent = 'Waiting...';
                }

                // Fetch wallet address
                const walletSnap = await getDoc(walletDocRef);
                if (walletSnap.exists() && walletSnap.data().address) {
                    piWalletAddressInput.value = walletSnap.data().address;
                } else {
                    piWalletAddressInput.value = "Wallet address unavailable";
                }
            } catch (error) {
                 console.error("Error fetching data:", error);
                 piPriceEl.textContent = 'Unavailable';
                 gcashRateEl.textContent = 'Unavailable';
                 piWalletAddressInput.value = "Error fetching address";
            }
        }
        
        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed:", error);
                showToast(`Login failed: ${error.message}`, 'error');
            }
        }

        function handleLogout() {
            signOut(auth);
        }

        function handleCopy(textToCopy, message) {
            navigator.clipboard.writeText(textToCopy).then(() => {
                showToast(message);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                showToast('Failed to copy text.', 'error');
            });
        }

        function calculateExpectedPayment() {
            const piAmount = parseFloat(piSentInput.value);

            if (isNaN(piAmount) || piAmount <= 0) {
                expectedPaymentEl.textContent = '₱0.00';
                return;
            }
            
            const expectedTotal = (piAmount * currentGcashRate) - 20;

            if (expectedTotal < 0) {
                expectedPaymentEl.textContent = 'Amount too low';
                expectedPaymentEl.classList.add('text-red-500');
            } else {
                expectedPaymentEl.textContent = `₱${expectedTotal.toFixed(2)}`;
                expectedPaymentEl.classList.remove('text-red-500');
            }
        }
        
        async function handleSubmitTransaction(e) {
            e.preventDefault();
            if (!user) {
                showToast("You must be logged in to submit a transaction.", 'error');
                return;
            }
            
            // Check admin status before showing modal
            if (adminStatus === 'offline') {
                offlineWarningModal.classList.remove('hidden');
            } else {
                showConfirmationModal();
            }
        }

        function showConfirmationModal() {
            const formData = new FormData(transactionForm);
             const transactionData = {
                piSent: parseFloat(formData.get('pi-sent')),
                gcashName: formData.get('gcash-name'),
                gcashNumber: formData.get('gcash-number'),
                rateAtSubmission: currentGcashRate
            };

            const confirmDetails = document.getElementById('confirm-details');
            confirmDetails.innerHTML = `
                <p><span class="font-bold text-gray-400">Pi Sent:</span> <span class="text-white">${transactionData.piSent}π</span></p>
                <p><span class="font-bold text-gray-400">GCash Name:</span> <span class="text-white">${transactionData.gcashName}</span></p>
                <p><span class="font-bold text-gray-400">GCash Number:</span> <span class="text-white">${transactionData.gcashNumber}</span></p>
                <p><span class="font-bold text-gray-400">Expected GCash:</span> <span class="text-green-400">₱${((transactionData.piSent * transactionData.rateAtSubmission) - 20).toFixed(2)}</span></p>
            `;
            confirmModal.classList.remove('hidden');
        }
        
        async function confirmAndSubmit() {
            const formData = new FormData(transactionForm);
            const transactionData = {
                userId: user.uid,
                userEmail: user.email,
                piSent: parseFloat(formData.get('pi-sent')),
                gcashName: formData.get('gcash-name'),
                gcashNumber: formData.get('gcash-number'),
                piWalletSource: formData.get('pi-wallet-source'),
                transactionTime: new Date(formData.get('transaction-datetime')),
                status: 'Pending Verification',
                createdAt: serverTimestamp(),
                adminNote: '',
                rateAtSubmission: currentGcashRate
            };

            const originalBtnHTML = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Submitting...
            `;
            
            confirmModal.classList.add('hidden');
            offlineWarningModal.classList.add('hidden');

            try {
                const newTransactionRef = doc(collection(db, "transactions"));
                transactionData.transactionId = newTransactionRef.id;
                await setDoc(newTransactionRef, transactionData);

                console.log("Transaction submitted with ID: ", newTransactionRef.id);
                showToast("Transaction submitted successfully! Ref ID: " + newTransactionRef.id);
                
                transactionForm.reset();
                calculateExpectedPayment();
            } catch (error) {
                console.error("Error adding document: ", error);
                showToast(`Error submitting transaction: ${error.message}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnHTML;
            }
        }
        
        function listenForTransactions() {
             if (transactionsUnsubscribe) transactionsUnsubscribe();
            if (!user) return;
            
            console.log("Setting up Firestore listener for user:", user.uid);
            const q = query(collection(db, "transactions"), where("userId", "==", user.uid), orderBy("createdAt", "desc"));
            
            transactionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                console.log("Received transaction update from Firestore.");
                transactionsList.innerHTML = '';
                if (querySnapshot.empty) {
                    transactionsList.innerHTML = `<p class="text-gray-500 text-center">Your submitted transactions will appear here.</p>`;
                    return;
                }
                querySnapshot.forEach((doc) => {
                    const tx = doc.data();
                    const date = tx.createdAt ? tx.createdAt.toDate().toLocaleString() : 'Just now';
                    
                    let statusColor = 'text-yellow-400';
                    if (tx.status === 'Paid') statusColor = 'text-green-400';
                    if (tx.status === 'Rejected') statusColor = 'text-red-400';
                    if (tx.status === 'In Progress') statusColor = 'text-blue-400';

                    let adminNoteHTML = '';
                    if (tx.adminNote && tx.adminNote.trim() !== '') {
                        adminNoteHTML = `
                            <div class="mt-2 pt-2 border-t border-gray-600">
                                <p class="text-xs text-gray-400 font-semibold">Admin Note:</p>
                                <p class="text-sm text-yellow-300 whitespace-pre-wrap">${tx.adminNote}</p>
                            </div>
                        `;
                    }

                    const txElement = document.createElement('div');
                    txElement.className = 'bg-gray-700 p-3 rounded-md text-sm';
                    txElement.innerHTML = `
                        <div class="flex justify-between items-center mb-1">
                            <p class="font-bold">Sent ${tx.piSent}π</p>
                            <p class="${statusColor} font-semibold">${tx.status}</p>
                        </div>
                        <p class="text-xs text-gray-400">GCash: ${tx.gcashNumber}</p>
                        <p class="text-xs text-purple-300 font-mono">ID: ${tx.transactionId || 'N/A'}</p>
                        <p class="text-xs text-gray-500 mt-1">${date}</p>
                        ${adminNoteHTML}
                    `;
                    transactionsList.appendChild(txElement);
                });
            }, (error) => {
                 console.error("Error listening to transactions: ", error);
            });
        }
        
        function listenForAdminStatus() {
            const statusDocRef = doc(db, "marketData", "adminStatus");
            onSnapshot(statusDocRef, (docSnap) => {
                if (docSnap.exists() && docSnap.data().status) {
                    adminStatus = docSnap.data().status;
                    if (adminStatus === 'online') {
                        statusDot.classList.remove('bg-red-500');
                        statusDot.classList.add('bg-green-500', 'animate-pulse');
                        statusText.textContent = 'Admin Status: Online';
                    } else {
                        statusDot.classList.remove('bg-green-500', 'animate-pulse');
                        statusDot.classList.add('bg-red-500');
                        statusText.textContent = 'Admin Status: Offline';
                    }
                } else {
                    adminStatus = 'unknown';
                    statusDot.classList.remove('bg-green-500', 'bg-red-500');
                    statusDot.classList.add('bg-gray-500');
                    statusText.textContent = 'Admin Status: Unknown';
                }
            }, (error) => {
                console.error("Error listening to admin status:", error);
                adminStatus = 'error';
                statusDot.classList.remove('bg-green-500', 'bg-red-500');
                statusDot.classList.add('bg-gray-500');
                statusText.textContent = 'Admin Status: Error';
            });
        }


        // --- MAIN INITIALIZATION ---
        function initApp() {
            // CENTRALIZED AUTHENTICATION CHECK: This is the correct place to handle the initial view logic.
            // onAuthStateChanged is the Firebase function that reliably tells us if a user is logged in.
            onAuthStateChanged(auth, (currentUser) => {
                user = currentUser;
                if (user) {
                    // If the user is logged in, show the Facebook gate.
                    showView('fbGate');
                } else {
                    // If not logged in, show the login screen.
                    showView('login');
                }
            });

            loginBtn.addEventListener('click', handleLogin);
            
            // The Facebook gate now redirects to the main app only when the user is logged in.
            fbContinueBtn.addEventListener('click', () => {
                if (user) {
                    enterMainApp();
                } else {
                    showToast("Please log in first to proceed.", 'error');
                }
            });
            
            copyAddressBtn.addEventListener('click', () => handleCopy(piWalletAddressInput.value, 'Pi Wallet Address copied!'));
            copyLinkBtn.addEventListener('click', () => handleCopy(window.location.href, 'Page Link copied!'));
            transactionForm.addEventListener('submit', handleSubmitTransaction);
            document.getElementById('confirm-submit-btn').addEventListener('click', confirmAndSubmit);
            document.getElementById('cancel-confirm-btn').addEventListener('click', () => {
                confirmModal.classList.add('hidden');
            });

            document.getElementById('proceed-offline-btn').addEventListener('click', confirmAndSubmit);
            document.getElementById('cancel-offline-btn').addEventListener('click', () => {
                offlineWarningModal.classList.add('hidden');
            });
            
            updatePriceBtn.addEventListener('click', fetchPriceAndWallet);

            piSentInput.addEventListener('input', () => {
                calculateExpectedPayment(); 
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    fetchPriceAndWallet(); 
                }, 500);
            });
            
            // Register user activity listeners to reset the inactivity timer
            ['mousemove', 'mousedown', 'keydown', 'touchstart'].forEach(event => {
                document.addEventListener(event, handleUserActivity, { passive: true });
            });
            
            // Detect and handle WebView
            if (detectInAppBrowser()) {
                appLaunchers.classList.add('hidden');
                webviewWarning.classList.remove('hidden');
            }
        }
        
        // This is the ONE AND ONLY entry point for the app.
        document.addEventListener('DOMContentLoaded', initApp);
        
        // Initial fetch of wallet address on page load
        async function fetchPiWalletAddress() {
            const walletDocRef = doc(db, "marketData", "piWallet");
            try {
                const docSnap = await getDoc(walletDocRef);
                if (docSnap.exists() && docSnap.data().address) {
                    piWalletAddressInput.value = docSnap.data().address;
                } else {
                    // Fallback to the hardcoded address if the database is not yet set up
                    piWalletAddressInput.value = "GB4GBQKCHJ7XBF6EQYMQHHYHXU7XPVTXUU2NJR37YUL6EFJ4243OFHDB";
                }
            } catch (error) {
                console.error("Error fetching wallet address:", error);
                 piWalletAddressInput.value = "Error fetching address";
            }
        }
    </script>
</body>
</html>
