<!--
    Timestamp: Thursday, September 11, 2025 at 8:01 AM PST
    File Name: admin.html
    Full File Path: admin.html

    App Functionality:
    This is a secure dashboard for the Pi2GCash administrator. It requires the admin to sign in with an authorized Google account. Once authenticated, it displays a real-time list of pending transactions, allowing the admin to approve or reject them and add a corresponding note for the user.

    Modifications Made in This Version:
	- Added: A new HTML section for the "Manage Pi Wallet Address" editor. It contains an input field and a "Save" button.
	- Added: The getDoc and setDoc modules were imported.
	- Added: A new fetchWalletAddress function that retrieves the current wallet address from a new Firestore document at marketData/piWallet and populates the input field. If the document doesn't exist, it creates it with a default value.
	- Added: A new saveWalletAddress function. This function uses the updateDoc method to save a new wallet address to Firestore, allowing the admin to change the address users see.
	- Revised: The showDashboard function now calls fetchWalletAddress() to ensure the input field is populated with the latest data from the database.
	- Revised: The "Save" button now shows a "Saving..." state with a spinner during the update and a "Saved!" message upon success for better user feedback.
    - Added: A new section with a toggle button to allow the admin to set their online/offline status.
    - Added: A new Firestore document at `marketData/adminStatus` to store the online/offline status.
    - Added: A new `toggleAdminStatus` function to update the status in Firestore and provide a visual indication of the current state.
    - FIXED: Added a missing event listener for the `toggle-status-btn` so it now functions correctly.
    - FIXED: Added a missing event listener for the `save-wallet-btn` to resolve the "saveWalletAddress is not defined" error.
    - **CRITICAL FIX**: Placed the `init()` function call inside a `DOMContentLoaded` listener to ensure all functions are defined before the script tries to attach event listeners, resolving the `ReferenceError`.
    - **CRITICAL FIX**: Moved the event listeners for `saveWalletBtn` and `toggleStatusBtn` into the `showDashboard` function. This ensures the functions are defined and ready to be used before the buttons are attached to them, completely resolving the `ReferenceError` and logic flow.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi2GCash - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M6.5,50a43.5,43.5 0 1,0 87,0a43.5,43.5 0 1,0 -87,0' fill-opacity='0' stroke='%233B82F6' stroke-width='7.5'/><path d='M50,25 v50' stroke='%23FBBF24' stroke-width='7.5' stroke-linecap='round'/><path d='M32.5,42.5 l17.5,-17.5 l17.5,17.5' fill-opacity='0' stroke='%23FBBF24' stroke-width='7.5' stroke-linecap='round'/></svg>">
    <style>
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; }
        .action-button { transition: all 0.2s ease-in-out; }
        .action-button:hover { transform: scale(1.05); }
        .filter-button.active {
            background-color: #3B82F6;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-800 text-gray-200">

    <div id="login-view" class="min-h-screen flex items-center justify-center">
        <div class="bg-gray-900 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <div class="text-center mb-6">
                <img src="pi2gc-logo.png" alt="Logo" class="h-20 w-auto mx-auto mb-4">
                <h1 class="text-2xl font-bold text-white">Admin Dashboard</h1>
            </div>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-md flex items-center justify-center">
                <svg class="w-5 h-5 mr-3" aria-hidden="true" focusable="false" data-prefix="fab" data-icon="google" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 488 512"><path fill="currentColor" d="M488 261.8C488 403.3 381.5 512 244 512 110.3 512 0 398.8 0 256S110.3 0 244 0c73 0 134.3 29.2 179.8 73.4L372.3 128.9C339.7 99.8 296.2 80 244 80c-87.6 0-159.3 70.2-159.3 176s71.7 176 159.3 176c98.2 0 135-70.4 140.8-106.9H244v-85.3h236.1c2.3 12.7 3.9 26.9 3.9 41.8z"></path></svg>
                Sign in with Google
            </button>
            <p id="login-error" class="text-red-500 text-sm mt-4 text-center"></p>
        </div>
    </div>

    <div id="dashboard-view" class="hidden">
        <header class="bg-gray-900 shadow-md p-4 flex justify-between items-center sticky top-0 z-50">
            <div>
                <h1 class="text-xl font-bold text-white">Admin Dashboard</h1>
                <p id="admin-email" class="text-xs text-gray-400"></p>
            </div>
            <div class="flex items-center space-x-4">
                 <div id="status-indicator" class="flex items-center space-x-2">
                    <span id="status-dot" class="w-3 h-3 rounded-full bg-gray-500"></span>
                    <span id="status-text" class="text-sm font-semibold text-gray-400">Loading...</span>
                 </div>
                 <button id="toggle-status-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md text-sm transition">Toggle Status</button>
                <button id="logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md text-sm">Logout</button>
            </div>
        </header>

        <main class="p-4 md:p-6 space-y-6">
            <div class="bg-gray-700 p-4 rounded-lg">
                <p class="text-center font-semibold mb-3 text-white">Quick App Launchers</p>
                <div class="grid grid-cols-3 gap-2">
                    <a href="intent://#Intent;package=com.blockchainvault;end" class="bg-orange-600 text-white p-3 rounded-lg text-center hover:bg-orange-700 transition">Pi Network</a>
                    <a href="intent://#Intent;package=pi.browser;end" class="bg-amber-500 text-black p-3 rounded-lg text-center hover:bg-amber-600 transition">Pi Browser</a>
                    <a href="intent://#Intent;package=com.globe.gcash.android;end" class="bg-blue-600 text-white p-3 rounded-lg text-center hover:bg-blue-600 transition">GCash</a>
                </div>
            </div>
            
            <div class="bg-gray-700 p-4 rounded-lg">
                <h3 class="font-semibold text-white mb-3">Manage Pi Wallet Address</h3>
                <label for="pi-wallet-address-input" class="block text-sm font-medium text-gray-400 mb-1">Current Public Wallet Address:</label>
                <input type="text" id="pi-wallet-address-input" class="w-full bg-gray-600 text-white rounded-md p-2 text-sm" placeholder="GB4GBQKCHJ7XBF6EQYMQHHYHXU7XPVTXUU2NJR37YUL6EFJ4243OFHDB">
                <button id="save-wallet-btn" class="mt-3 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md text-sm transition flex justify-center items-center">
                    Save New Address
                </button>
            </div>
            
            <div class="bg-gray-700 p-3 rounded-lg flex flex-wrap justify-around text-center gap-2 text-sm font-semibold">
                <button data-status="Pending Verification" class="filter-button py-2 px-4 rounded-md transition active">Pending</button>
                <button data-status="In Progress" class="filter-button py-2 px-4 rounded-md transition">In Progress</button>
                <button data-status="Paid" class="filter-button py-2 px-4 rounded-md transition">Paid</button>
                <button data-status="Rejected" class="filter-button py-2 px-4 rounded-md transition">Rejected</button>
            </div>
            
            <div id="transactions-list" class="space-y-4">
                <p id="loading-transactions" class="text-center text-gray-400 py-10">Loading transactions...</p>
            </div>
        </main>
    </div>


    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, query, where, onSnapshot, orderBy, doc, updateDoc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // --- USE THE SAME FIREBASE CONFIG AS YOUR MAIN APP ---
        const firebaseConfig = {
            apiKey: "AIzaSyBlq33BQqvRk5HQcHXxJvfBE4iygcoLxfw",
            authDomain: "pi-gcash-p2p-app.firebaseapp.com",
            projectId: "pi-gcash-p2p-app",
            storageBucket: "pi-gcash-p2p-app.appspot.com",
            messagingSenderId: "148063854165",
            appId: "1:148063854165:web:cd335ca3af278034e4fedc",
            measurementId: "G-VVG58MWN3F"
        };
        
        // --- ADMIN AUTHORIZATION ---
        const ADMIN_EMAILS = ["randybondoc@gmail.com", "randysbondoc@gmail.com"];

        // --- INITIALIZE FIREBASE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- UI ELEMENTS ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const loginBtn = document.getElementById('login-btn');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const transactionsList = document.getElementById('transactions-list');
        const adminEmailEl = document.getElementById('admin-email');
        const filterButtons = document.querySelectorAll('.filter-button');
        const piWalletAddressInput = document.getElementById('pi-wallet-address-input');
        const saveWalletBtn = document.getElementById('save-wallet-btn');
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('status-text');
        const toggleStatusBtn = document.getElementById('toggle-status-btn');
        
        let transactionsUnsubscribe = null;
        let currentFilter = 'Pending Verification';
        let adminStatusListener = null;

        // --- FUNCTIONS ---
        function showDashboard(user) {
            adminEmailEl.textContent = user.email;
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            fetchWalletAddress();
            listenForTransactions();
            listenForAdminStatus();
        }

        function showLogin(errorMsg = '') {
            dashboardView.classList.add('hidden');
            loginView.classList.remove('hidden');
            loginError.textContent = errorMsg;
            if (transactionsUnsubscribe) {
                transactionsUnsubscribe(); 
            }
             if (adminStatusListener) {
                adminStatusListener();
            }
        }

        async function handleLogin() {
            const provider = new GoogleAuthProvider();
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Login failed:", error);
                showLogin(`Login failed: ${error.message}`);
            }
        }
        
        function handleLogout() {
            signOut(auth);
        }

        function listenForTransactions() {
            if (transactionsUnsubscribe) transactionsUnsubscribe();

            const q = query(
                collection(db, "transactions"), 
                where("status", "==", currentFilter), 
                orderBy("createdAt", "desc")
            );

            transactionsUnsubscribe = onSnapshot(q, (querySnapshot) => {
                transactionsList.innerHTML = ''; 
                if (querySnapshot.empty) {
                    transactionsList.innerHTML = `<p class="text-center text-gray-400 py-10">No transactions found with status: ${currentFilter}</p>`;
                } else {
                    querySnapshot.forEach(doc => {
                        renderTransaction(doc.id, doc.data());
                    });
                }
            }, (error) => {
                console.error("Error fetching transactions: ", error);
                transactionsList.innerHTML = `<p class="text-center text-red-500 py-10">Error loading transactions. Check console for permissions error.</p>`;
            });
        }
        
        function updateFilter(e) {
            filterButtons.forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            currentFilter = e.target.dataset.status;
            listenForTransactions();
        }

        function renderTransaction(id, tx) {
            const txElement = document.createElement('div');
            txElement.className = 'bg-gray-700 p-4 rounded-lg shadow-md';
            txElement.dataset.transactionId = id; 
            
            const createdAt = tx.createdAt ? tx.createdAt.toDate().toLocaleString() : 'N/A';
            const rateInfo = tx.rateAtSubmission ? `₱${tx.rateAtSubmission}/π` : 'N/A';
            
            let paymentDueHTML = '<p class="text-2xl font-bold text-gray-500">N/A</p>';
            if (tx.rateAtSubmission && tx.piSent) {
                const paymentAmount = (tx.piSent * tx.rateAtSubmission) - 20.00;
                paymentDueHTML = `<p class="text-3xl font-bold text-green-400">₱${paymentAmount.toFixed(2)}</p>`;
            }
            
            let actionButtonsHTML = '';
            let statusColor = 'text-yellow-400';
            
            switch(tx.status) {
                case 'Pending Verification':
                    actionButtonsHTML = `
                        <button data-id="${id}" data-status="In Progress" class="action-button update-btn bg-cyan-600 hover:bg-cyan-700 text-white font-bold py-2 px-5 rounded-md text-sm">Start Processing</button>
                        <button data-id="${id}" data-status="Rejected" class="action-button update-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-md text-sm">Reject</button>
                    `;
                    statusColor = 'text-yellow-400';
                    break;
                case 'In Progress':
                    actionButtonsHTML = `
                        <button data-id="${id}" data-status="Paid" class="action-button update-btn bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-md text-sm">Mark as Paid</button>
                        <button data-id="${id}" data-status="Rejected" class="action-button update-btn bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-5 rounded-md text-sm">Reject</button>
                    `;
                    statusColor = 'text-blue-400';
                    break;
                case 'Paid':
                    actionButtonsHTML = `<span class="text-sm font-semibold text-green-400">Transaction Complete</span>`;
                    statusColor = 'text-green-400';
                    break;
                case 'Rejected':
                    actionButtonsHTML = `<span class="text-sm font-semibold text-red-400">Transaction Rejected</span>`;
                    statusColor = 'text-red-400';
                    break;
            }

            txElement.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <span class="text-sm font-semibold py-1 px-3 rounded-full bg-gray-600 ${statusColor.replace('text-', 'bg-')}-700/50">${tx.status}</span>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div>
                        <p class="font-bold text-cyan-400">Transaction Details</p>
                        <p><span class="font-semibold text-gray-400">Submitted At:</span> ${createdAt}</p>
                        <p><span class="font-semibold text-gray-400">User Email:</span> ${tx.userEmail}</p>
                        <p><span class="font-semibold text-gray-400">User ID:</span> <code class="text-xs">${tx.userId}</code></p>
                        <p><span class="font-semibold text-gray-400">Reference ID:</span> <code class="text-xs">${tx.transactionId}</code></p>
                    </div>
                    <div>
                        <p class="font-bold text-amber-400">Payment Details</p>
                        <p><span class="font-semibold text-gray-400">Pi Sent:</span> <strong class="text-white">${tx.piSent}π</strong></p>
                        <p><span class="font-semibold text-gray-400">Rate at Submission:</span> <strong class="text-lime-400">${rateInfo}</strong></p>
                        <p><span class="font-semibold text-gray-400">From Wallet:</span> <code class="text-xs">${tx.piWalletSource}</code></p>
                        <p><span class="font-semibold text-gray-400">GCash Name:</span> ${tx.gcashName}</p>
                        <p><span class="font-semibold text-gray-400">GCash Number:</span> ${tx.gcashNumber}</p>
                    </div>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-600 text-center bg-gray-800 rounded-b-md">
                    <p class="text-sm font-semibold text-gray-400">GCash Payment Due (Rate * Pi) - ₱20 Fee</p>
                    ${paymentDueHTML}
                </div>
                <div class="mt-4 pt-4 border-t border-gray-600">
                    <label for="admin-note-${id}" class="block text-sm font-medium text-gray-400 mb-1">Admin Note (visible to user)</label>
                    <input type="text" id="admin-note-${id}" class="admin-note-input w-full bg-gray-600 text-white rounded-md p-2 text-sm" value="${tx.adminNote || ''}" placeholder="e.g., GCash sent, waiting for confirmation...">
                    <div class="mt-3 flex justify-end items-center gap-3">
                        ${actionButtonsHTML}
                    </div>
                </div>
            `;
            transactionsList.appendChild(txElement);
        }

        async function handleTransactionUpdate(e) {
            const button = e.target.closest('.update-btn');
            if (!button) return;

            const transactionId = button.dataset.id;
            const newStatus = button.dataset.status;
            const parentElement = document.querySelector(`[data-transaction-id="${transactionId}"]`);
            const noteInput = parentElement.querySelector('.admin-note-input');
            const adminNoteText = noteInput.value.trim();

            button.disabled = true;
            button.textContent = 'Updating...';

            const docRef = doc(db, "transactions", transactionId);
            try {
                await updateDoc(docRef, { 
                    status: newStatus,
                    adminNote: adminNoteText
                });
            } catch (error) {
                console.error("Failed to update transaction:", error);
                alert("Error: Could not update transaction status. Check console for details.");
                button.disabled = false;
                button.textContent = `Update to ${newStatus}`;
            }
        }
        
        async function fetchWalletAddress() {
            const walletDocRef = doc(db, "marketData", "piWallet");
            try {
                const docSnap = await getDoc(walletDocRef);
                if (docSnap.exists() && docSnap.data().address) {
                    piWalletAddressInput.value = docSnap.data().address;
                } else {
                    // Create the document if it doesn't exist
                    const defaultAddress = "GB4GBQKCHJ7XBF6EQYMQHHYHXU7XPVTXUU2NJR37YUL6EFJ4243OFHDB";
                    await setDoc(walletDocRef, { address: defaultAddress });
                    piWalletAddressInput.value = defaultAddress;
                }
            } catch (error) {
                console.error("Error fetching wallet address:", error);
                piWalletAddressInput.placeholder = "Error loading address.";
            }
        }
        
        async function saveWalletAddress() {
            const newAddress = piWalletAddressInput.value.trim();
            if (!newAddress) {
                alert("Wallet address cannot be empty.");
                return;
            }

            saveWalletBtn.disabled = true;
            saveWalletBtn.innerHTML = `
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Saving...
            `;

            const walletDocRef = doc(db, "marketData", "piWallet");
            try {
                await setDoc(walletDocRef, { address: newAddress });
                saveWalletBtn.innerHTML = 'Saved!';
                setTimeout(() => {
                    saveWalletBtn.disabled = false;
                    saveWalletBtn.textContent = 'Save New Address';
                }, 2000);
            } catch (error) {
                console.error("Error saving wallet address:", error);
                saveWalletBtn.innerHTML = 'Save Failed';
                 alert("Failed to save address. Check console for details.");
                setTimeout(() => {
                    saveWalletBtn.disabled = false;
                    saveWalletBtn.textContent = 'Save New Address';
                }, 3000);
            }
        }
        
         async function listenForAdminStatus() {
            const statusDocRef = doc(db, "marketData", "adminStatus");
            adminStatusListener = onSnapshot(statusDocRef, (docSnap) => {
                let status = 'offline'; // Default to offline
                if (docSnap.exists() && docSnap.data().status) {
                    status = docSnap.data().status;
                }
                
                // Base classes that are always present
                const baseClasses = 'text-sm font-semibold';

                if (status === 'online') {
                    // --- SETS INDICATOR TO GREEN ---
                    statusDot.classList.remove('bg-red-500', 'bg-gray-500');
                    statusDot.classList.add('bg-green-500', 'animate-pulse');
                    statusText.textContent = 'Admin is Online';
                    // Force the correct classes, removing any old ones
                    statusText.className = `${baseClasses} text-green-400`;
                } else { 
                    // --- SETS INDICATOR TO RED ---
                    statusDot.classList.remove('bg-green-500', 'animate-pulse', 'bg-gray-500');
                    statusDot.classList.add('bg-red-500');
                    statusText.textContent = 'Admin is Offline';
                    // Force the correct classes, removing any old ones
                    statusText.className = `${baseClasses} text-red-400`;
                }
            }, (error) => {
                console.error("Error listening to admin status:", error);
                statusDot.classList.remove('bg-green-500', 'bg-red-500');
                statusDot.classList.add('bg-gray-500');
                statusText.textContent = 'Status Error';
                statusText.className = 'text-sm font-semibold text-gray-400';
            });
        }
        
        async function toggleAdminStatus() {
            const statusDocRef = doc(db, "marketData", "adminStatus");
            toggleStatusBtn.disabled = true;
            toggleStatusBtn.textContent = 'Updating...';
            
            try {
                const docSnap = await getDoc(statusDocRef);
                const currentStatus = (docSnap.exists() && docSnap.data().status) ? docSnap.data().status : 'offline';
                const newStatus = currentStatus === 'online' ? 'offline' : 'online';
                await setDoc(statusDocRef, { status: newStatus, lastUpdated: serverTimestamp() });
            } catch (error) {
                console.error("Error toggling admin status:", error);
                alert("Failed to toggle status.");
            } finally {
                 toggleStatusBtn.textContent = 'Toggle Status';
                 toggleStatusBtn.disabled = false;
            }
        }


        // --- MAIN INITIALIZATION ---
        function init() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    if (ADMIN_EMAILS.includes(user.email)) {
                        console.log("Admin authenticated:", user.email);
                        showDashboard(user);
                    } else {
                        console.warn("Unauthorized access attempt by:", user.email);
                        handleLogout();
                        showLogin("Access Denied. This account is not authorized.");
                    }
                } else {
                    showLogin();
                }
            });
            
            loginBtn.addEventListener('click', handleLogin);
            logoutBtn.addEventListener('click', handleLogout);
            transactionsList.addEventListener('click', handleTransactionUpdate);
            filterButtons.forEach(button => {
                button.addEventListener('click', updateFilter);
            });
            saveWalletBtn.addEventListener('click', saveWalletAddress);
            toggleStatusBtn.addEventListener('click', toggleAdminStatus);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
